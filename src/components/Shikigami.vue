<script lang="ts">
import type { ObserverType } from './Observer.vue'
import { SvgClass } from './Svg.vue'
import type { svgType } from './Svg.vue'
import type { timeBase } from './Suntime.vue'
import { drawEarth } from './shikigami/DrawSun.vue'
import { drawMoon } from './shikigami/DrawMoon.vue'
import { drawGraph } from './shikigami/DrawGraph.vue'
import { drawMercury } from './shikigami/DrawMercury.vue'
import { drawVenus } from './shikigami/DrawVenus.vue'
import { drawMars } from './shikigami/DrawMars.vue'
import { drawJupiter } from './shikigami/DrawJupiter.vue'
import { drawSaturn } from './shikigami/DrawSaturn.vue'
import { drawUranus } from './shikigami/DrawUranus.vue'
import { drawNeptune } from './shikigami/DrawNeptune.vue'
import { drawPluto } from './shikigami/DrawPluto.vue'


// 定数
const RAD = Math.PI / 180;
const SVG_LINE_WIDTH = 0.25;
const SVG_WIDTH = 1683.7795;
const SVG_HEIGHT = 2383.937;
const SVG_LEFT = 841.8896;
const SVG_TOP = 1191.9687;
const SVG_AUR = 424.0488; // 1AU = 424.0488px
const WHITE_COLOR = '#FFFFFF';
const BLACK_COLOR = '#000000';
const RED_COLOR = '#FF0000';
const GREEN_COLOR = '#33CC33';

let svg: svgType;

export const downloadSVG = () => {
  svg.download();
}

type DaysData = {
  start: Date
  end: Date
  data: Array<{ date: number, value: number }>
}
// SHIKIGAMIメインルーチン
export const shikigami = (observer: ObserverType, flagDraw: {
  isDrawEarth: boolean,
  isDrawMoon: boolean,
  isDrawMercury: boolean,
  isDrawVenus: boolean,
  isDrawMars: boolean,
  isDrawJupiter: boolean,
  isDrawSaturn: boolean,
  isDrawUranus: boolean,
  isDrawNeptune: boolean,
  isDrawPluto: boolean,
  isDrawSunrise: boolean,
  isDrawSunset: boolean,
  isDrawDayArea: boolean,
  isDrawNightArea: boolean,
}, eachDaysData: DaysData, drawTime: timeBase, graphMin: number, graphMax: number) => {
  let svgImage;
  let flagSunrise: boolean, flagSunset: boolean;
  let flagDay: boolean, flagNight: boolean;
  let flagDrawTime: boolean;
  const svgLineR = 583.54395;
  const svgSize = 1.723;

  svgImage = document.getElementById('svgImage') as HTMLElement;
  const areaWidth = (svgImage.offsetWidth > 1080) ? 1080 : svgImage.offsetWidth;

  svg = new SvgClass(observer.initDt, SVG_WIDTH, SVG_HEIGHT, SVG_LEFT, SVG_TOP, areaWidth);
  // 通日ラベルフォント
  svg.tag(`<style>.days{font-family: DroidSans, Droid Sans; font-size: 3.2px; color: #000000; stroke-width: 0.25; text-anchor: middle;}</style>`);
  svg.groupId(`ガイド基準`);
  svg.groupId(`中心点`);
  svg.circle(0, 0, svgSize, SVG_LINE_WIDTH, BLACK_COLOR, WHITE_COLOR,);
  svg.groupFooter();
  svg.groupId(`春分点方向線`);
  svg.line(0, 0, svgLineR, 0, SVG_LINE_WIDTH, RED_COLOR);
  svg.groupFooter();
  svg.groupFooter();

  // 描画フラグ設定
  flagSunrise = flagDraw.isDrawSunrise;
  flagSunset = flagDraw.isDrawSunset;
  flagDay = flagDraw.isDrawDayArea;
  flagNight = flagDraw.isDrawNightArea;

  // 描画基準時刻設定
  flagDrawTime = drawTime === 'clock';

  // 惑星描画
  if (flagDraw.isDrawEarth) { drawEarth(svg, observer, flagSunrise, flagSunset, flagDay, flagNight, drawTime,); }
  if (flagDraw.isDrawEarth) { drawGraph(svg, observer, drawTime, eachDaysData, graphMin, graphMax); }
  if (flagDraw.isDrawMoon) { drawMoon(svg, observer, drawTime); }
  if (flagDraw.isDrawMercury) { drawMercury(svg, observer, drawTime); } // ng
  if (flagDraw.isDrawVenus) { drawVenus(svg, observer, drawTime); } // OK
  if (flagDraw.isDrawMars) { drawMars(svg, observer, drawTime); } // ng
  if (flagDraw.isDrawJupiter) { drawJupiter(svg, observer, drawTime); } // ok
  if (flagDraw.isDrawSaturn) { drawSaturn(svg, observer, drawTime); } // ok
  if (flagDraw.isDrawUranus) { drawUranus(svg, observer, drawTime); } // ok
  if (flagDraw.isDrawNeptune) { drawNeptune(svg, observer, drawTime); } // ok
  if (flagDraw.isDrawPluto) { drawPluto(svg, observer, drawTime); } // ng

  svg.groupId(`出力情報`);
  svg.tag(`<text transform="translate(100,${SVG_HEIGHT - 210})">描画開始日：${observer.initDt.toLocaleDateString()}</text>`);
  svg.tag(`<text transform="translate(100,${SVG_HEIGHT - 180})">描画場所：${observer.name} 経度 ${observer.longitude} / 緯度 ${observer.latitude} / タイムゾーン UTC+${observer.timezone}</text>`);
  svg.tag(`<text transform="translate(100,${SVG_HEIGHT - 150})">描画基準時刻：${flagDrawTime ? '正午／正子' : '南中／北中'}</text>`);
  svg.tag(`<text transform="translate(100,${SVG_HEIGHT - 100})">Generated by SHIKIGAMI 2.1.3 / Copyright(C)2021 Will System Design</text>`);
  svg.groupFooter();
  svg.end();

  svgImage = document.getElementById('svgImage') as HTMLElement;
  svgImage.innerHTML = svg.string;
}


let defaultObject = {};
export default defaultObject;
</script>

